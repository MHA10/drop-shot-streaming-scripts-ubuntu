<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSE Testing Server</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin: 20px 0;
      }
      button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .btn-start {
        background-color: #28a745;
        color: white;
      }
      .btn-start:hover {
        background-color: #218838;
      }
      .btn-stop {
        background-color: #dc3545;
        color: white;
      }
      .btn-stop:hover {
        background-color: #c82333;
      }
      .btn-connect {
        background-color: #007bff;
        color: white;
      }
      .btn-connect:hover {
        background-color: #0056b3;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .events-log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
      }
      .event-item {
        background-color: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        font-family: monospace;
        font-size: 12px;
      }
      .timestamp {
        color: #6c757d;
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>SSE Testing Server</h1>

      <div class="form-group">
        <label for="eventType">Event Type:</label>
        <select id="eventType">
          <option value="start">start</option>
          <option value="stop">stop</option>
          <option value="version-update">version-update</option>
        </select>
      </div>

      <div class="form-group">
        <label for="cameraUrl">Camera URL (RTSP):</label>
        <input
          type="text"
          id="cameraUrl"
          value="rtsp://admin:ubnt%40966@192.168.10.111:554/cam/realmonitor?channel=1&subtype=1"
          placeholder="Enter RTSP URL"
        />
      </div>

      <div class="form-group">
        <label for="streamKey">Stream Key:</label>
        <input
          type="text"
          id="streamKey"
          value="pda4-j9yb-hhc9-6t6k-7phr"
          placeholder="Enter YouTube stream key"
        />
      </div>

      <div class="form-group">
        <label for="courtId">Court ID:</label>
        <input
          type="text"
          id="courtId"
          value="court-001"
          placeholder="Enter Court ID"
        />
      </div>

      <div class="form-group">
        <label for="version">Version:</label>
        <input
          type="text"
          id="version"
          value="1.0.1"
          placeholder="Enter Version"
        />
      </div>

      <p>Cam 2 Key: `pjzb-r0va-wqcj-uvcq-7gsm`</p>

      <div class="button-group">
        <button class="btn-connect" onclick="connectSSE()">
          Connect to SSE
        </button>
        <button class="btn-start" onclick="sendEvent()">Send Event</button>
      </div>

      <div id="status" class="status disconnected">Disconnected from SSE</div>

      <div class="events-log">
        <h3>Events Log:</h3>
        <div id="eventsLog"></div>
      </div>
    </div>

    <script>
      let eventSource = null;
      let isConnected = false;

      function updateStatus(connected, message = "") {
        const statusDiv = document.getElementById("status");
        isConnected = connected;

        if (connected) {
          statusDiv.className = "status connected";
          statusDiv.textContent =
            "Connected to SSE" + (message ? ` - ${message}` : "");
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.textContent =
            "Disconnected from SSE" + (message ? ` - ${message}` : "");
        }
      }

      function addEventToLog(data, type = "received") {
        const eventsLog = document.getElementById("eventsLog");
        const eventItem = document.createElement("div");
        eventItem.className = "event-item";

        const timestamp = new Date().toLocaleTimeString();
        const eventData =
          typeof data === "string" ? data : JSON.stringify(data, null, 2);

        eventItem.innerHTML = `
                <div class="timestamp">${timestamp} - ${type.toUpperCase()}</div>
                <pre>${eventData}</pre>
            `;

        eventsLog.insertBefore(eventItem, eventsLog.firstChild);

        // Keep only last 20 events
        while (eventsLog.children.length > 20) {
          eventsLog.removeChild(eventsLog.lastChild);
        }
      }

      function connectSSE() {
        if (eventSource) {
          eventSource.close();
        }

        eventSource = new EventSource("/events");

        eventSource.onopen = function (event) {
          updateStatus(true, "Connection opened");
          addEventToLog("SSE connection established", "system");
        };

        eventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            addEventToLog(data, "received");
            console.log("Received SSE event:", data);
          } catch (error) {
            addEventToLog(event.data, "received");
            console.log("Received SSE data:", event.data);
          }
        };

        eventSource.onerror = function (event) {
          updateStatus(false, "Connection error");
          addEventToLog("SSE connection error", "error");
          console.error("SSE error:", event);
        };
      }

      async function sendEvent() {
        const eventType = document.getElementById("eventType").value;
        const cameraUrl = document.getElementById("cameraUrl").value;
        const streamKey = document.getElementById("streamKey").value;
        const courtId = document.getElementById("courtId").value;
        const version = document.getElementById("version").value;

        const eventData = {
          eventType,
          cameraUrl,
          streamKey,
          courtId,
          version,
        };

        try {
          const response = await fetch("/send-event", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(eventData),
          });

          const result = await response.json();
          addEventToLog(eventData, "sent");
          addEventToLog(
            `Event sent successfully to ${result.clients} clients`,
            "system"
          );
          console.log("Event sent:", result);
        } catch (error) {
          addEventToLog(`Error sending event: ${error.message}`, "error");
          console.error("Error sending event:", error);
        }
      }

      // Auto-connect on page load
      window.addEventListener("load", function () {
        connectSSE();
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", function () {
        if (eventSource) {
          eventSource.close();
        }
      });
    </script>
  </body>
</html>
